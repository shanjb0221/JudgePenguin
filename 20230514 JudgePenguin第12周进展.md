# JudgePenguin 第12周进展

因为 THUSC 摆了两周，本周主要上手重构了之前的一些代码，找回手感

在内核模块方面推进了一些进度；监控程序方面进行了一些调研与规划；意识到急需上线更强力的调试手段

## 内核模块

继续学习 jailhouse

- 向 Linux 注册了一个**设备** (`/dev/JudgePenguin`)，可以在 <u>Linux 用户态</u>通过 `ioctl` 实现对内核模块的简单控制

  ***TODO***：发现主函数重入时崩溃，大致定位到问题在保存或恢复 Linux 内核状态上 : (

  观察到 jailhouse 尝试把自己伪装成一个 PCI 设备，不清楚这样做的意义，暂时没抄过来 (?)

- 将监控程序 (bin) 作为设备的**固件**“安装”到 `/lib/firmware/jpenguin_kernel.bin`，使x用 `request_firmware` 加载（替换掉使用 `filp` 的加载方式）

- 加载监控程序时在预留内存上分配内核栈，通过参数传递给监控程序（替换掉使用 bin 中的 `.data` 段的实现）

  ***TODO***：目前内核栈使用的仍是 Linux 虚存地址，尝试修改 `%rsp` 切换到 JPenguin 虚存（与物理地址恒同映射）但立即崩溃 XD

  怀疑可能是因为在 C 函数中使用内嵌 `asm` 修改 `%rsp` 并不科学

***TODO***：尽快塞进 QEMU 调试（学习 RVM 1.5）


## 监控程序

### × 调研 Xenomai

#### Mercury 形式

下载了一份最新版，发现有且只有一个数千行的 Linux 内核的 `.patch` 文件

发现它从 `irq_save` / `irq_restore` 开始 patch 了几乎所有中断异常相关的内核函数，我大受震撼

感觉这样并不优美，与我的设计理念背道而驰，决定跑路

#### Cobalt 形式

双内核（向 Linux 添加另一个实时内核）

我希望尽可能屏蔽所欲干扰项，双内核与此差得更远

### 迁移 Judge Duck

大致观看了 jailhouse 对 `idt` 的修改，发现涉及很多中断代理的内容，码量巨大且功能相差较大，迁移难度大，收益较低，遂放弃

仔细阅读了 Judge Duck 的启动流程，发现它对 `idt`、`apic` 进行了良好的初始化，准备先迁移过来；之后再慢慢研究哪些东西需要保存并恢复

事实上，除了 `idt` 与 `apic` 外，其他所有 (?) Linux 内核状态均已经仿照 jailhouse 完成了保存与恢复

***TODO***：自底向上完成 Judge Duck 迁移（先单次调通，再考虑状态恢复）

## 下周计划

- 在 QEMU 上调试：
  - 解决主函数重入时崩溃、切换 `%rsp` 导致崩溃的问题
- 迁移 Judge Duck 的底层（主要初始化 `idt`、`apic` 部分）

## DEMO

